#    rpmio.at: Misc (librpm)io tests

AT_BANNER([I/O])

# test too unstable for production
#AT_SETUP([SIGPIPE from --pipe])
#AT_KEYWORDS([signals])
#AT_CHECK([
#RPMDB_CLEAR
#RPMDB_INIT
#
#runroot rpmbuild --quiet --with manyfiles -bb /data/SPECS/sigpipe.spec
#runroot rpm -qpl /build/RPMS/noarch/sigpipe-1.0-1.noarch.rpm --pipe "cat" | head -1
#],
#[0],
#[/opt/sigpipe/data
#],
#[])
#AT_CLEANUP

AT_SETUP([SIGPIPE from install scriptlet])
AT_KEYWORDS([signals])
AT_CHECK([
RPMDB_INIT

runroot rpmbuild --quiet -bb /data/SPECS/sigpipe.spec
runroot rpm -U --nodeps /build/RPMS/noarch/sigpipe-1.0-1.noarch.rpm
],
[0],
[],
[])
AT_CLEANUP

# XXX TODO: test for RhBug:471591 too, but needs a simpler reproducer

# test too unstable for production
#AT_SETUP([SIGPIPE in build scriptlet])
#AT_KEYWORDS([signals])
#AT_CHECK([
#RPMDB_CLEAR
#RPMDB_INIT
#
#run rpmbuild --quiet --with buildpipe -bb "${RPMDATA}/SPECS/sigpipe.spec"
#],
#[0],
#[],
#[])
#AT_CLEANUP

AT_SETUP([rpmlog error handling])
AT_KEYWORDS([log])
AT_CHECK([
RPMDB_INIT

runroot rpm -qpl /data/RPMS/hello-2.0-1.x86_64.rpm > /dev/full
],
[0],
[],
[Error writing to log: No space left on device
])
AT_CLEANUP
